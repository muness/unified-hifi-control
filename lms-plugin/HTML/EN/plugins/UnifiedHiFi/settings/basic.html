[% PROCESS settings/header.html %]
    [% title = "PLUGIN_UNIFIED_HIFI" %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI" desc="" %]
    <!-- Binary download status -->
    [% IF binaryStatus == 'not_downloaded' %]
    <div class="prefDesc" style="padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 15px;">
        <b>&#9888; Binary Required:</b> The bridge binary for <code>[% binaryPlatform %]</code> (~75 MB)
        will be downloaded when you click "Start Bridge".
    </div>
    [% ELSIF binaryStatus == 'downloading' %]
    <div class="prefDesc" style="padding: 10px; background: #cce5ff; border: 1px solid #007bff; border-radius: 4px; margin-bottom: 15px;">
        <b>&#8635; Downloading:</b> Binary for <code>[% binaryPlatform %]</code> is being downloaded...
        <br/><small>This may take a few minutes. Page will refresh automatically.</small>
        <script>setTimeout(function() { location.reload(); }, 5000);</script>
    </div>
    [% END %]

    <!-- Status indicator -->
    <div class="prefDesc">
        <b>[% "PLUGIN_UNIFIED_HIFI_STATUS" | string %]:</b>
        [% IF running %]
            <span style="color: #28a745; font-weight: bold;">
                &#9679; [% "PLUGIN_UNIFIED_HIFI_RUNNING" | string %]
            </span>
            &nbsp;&nbsp;
            <a href="[% webUrl %]" target="_blank">
                [% "PLUGIN_UNIFIED_HIFI_OPENUI" | string %] &#8594;
            </a>
        [% ELSE %]
            <span style="color: #dc3545; font-weight: bold;">
                &#9679; [% "PLUGIN_UNIFIED_HIFI_STOPPED" | string %]
            </span>
        [% END %]
    </div>

    <!-- Manual start/stop -->
        [% IF running %]
            <input type="submit" name="stop" value="[% "PLUGIN_UNIFIED_HIFI_STOP_BRIDGE" | string %]" />
        [% ELSE %]
            <input type="submit" name="start" value="[% "PLUGIN_UNIFIED_HIFI_START_BRIDGE" | string %]" />
        [% END %]
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_AUTORUN" desc="PLUGIN_UNIFIED_HIFI_AUTORUN_DESC" %]
        <input type="checkbox" name="pref_autorun" id="pref_autorun"
               value="1" [% IF prefs.autorun %]checked[% END %] />
        <label for="pref_autorun">Enable auto-start</label>
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_PORT" desc="PLUGIN_UNIFIED_HIFI_PORT_DESC" %]
        <input type="number" name="pref_port" id="pref_port"
               value="[% prefs.port || 8088 %]" min="1024" max="65535"
               style="width: 80px;" />
    [% END %]

    [% IF binaries.size > 1; WRAPPER setting title="PLUGIN_UNIFIED_HIFI_BINARY" desc="PLUGIN_UNIFIED_HIFI_BINARY_DESC" %]
        <select name="pref_bin" id="pref_bin">
            [% FOREACH bin IN binaries %]
                <option value="[% bin %]"
                        [% IF prefs.bin == bin %]selected[% END %]>
                    [% bin %]
                </option>
            [% END %]
        </select>
    [% END; END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_LOGLEVEL" desc="PLUGIN_UNIFIED_HIFI_LOGLEVEL_DESC" %]
        <select name="pref_loglevel" id="pref_loglevel">
            [% FOREACH level IN loglevels %]
                <option value="[% level %]"
                        [% IF prefs.loglevel == level %]selected[% END %]>
                    [% level %]
                </option>
            [% END %]
        </select>
    [% END %]

<!-- Knob Configuration Section -->
    <hr/>
    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_KNOB" desc="" %]

    [% IF knobStatus.last_seen %]
    <div class="prefDesc" style="padding: 8px; background: #e8f5e9; border-radius: 4px; margin-bottom: 10px;">
        <b>Status:</b> Connected
        &nbsp;|&nbsp; <b>ID:</b> [% knobStatus.knob_id %]
        [% IF knobStatus.version %]&nbsp;|&nbsp; <b>Firmware:</b> [% knobStatus.version %][% END %]
        [% IF knobStatus.status.battery_level %]
            &nbsp;|&nbsp; <b>Battery:</b> [% knobStatus.status.battery_level %]%
            [% IF knobStatus.status.battery_charging %](charging)[% END %]
        [% END %]
    </div>
    [% END %]

    <div class="prefDesc">
        [% "PLUGIN_UNIFIED_HIFI_KNOB_DESC" | string %]
    </div>
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_KNOB_NAME" desc="PLUGIN_UNIFIED_HIFI_KNOB_NAME_DESC" %]
        <input type="text" name="pref_knob_name" id="pref_knob_name"
               value="[% prefs.knob_name %]" style="width: 200px;"
               placeholder="My Knob" />
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_KNOB_ROTATION" desc="PLUGIN_UNIFIED_HIFI_KNOB_ROTATION_DESC" %]
    [% SET rot_charging = prefs.knob_rotation_charging.defined ? prefs.knob_rotation_charging : 180 %]
    [% SET rot_battery = prefs.knob_rotation_battery.defined ? prefs.knob_rotation_battery : 0 %]
        <label style="display: inline-block; width: 120px;">When charging:</label>
        <select name="pref_knob_rotation_charging" id="pref_knob_rotation_charging">
            [% FOREACH rot IN rotations %]
                <option value="[% rot %]"
                        [% IF rot_charging == rot %]selected[% END %]>
                    [% rot %]&deg;
                </option>
            [% END %]
        </select>
        <br/><br/>
        <label style="display: inline-block; width: 120px;">On battery:</label>
        <select name="pref_knob_rotation_battery" id="pref_knob_rotation_battery">
            [% FOREACH rot IN rotations %]
                <option value="[% rot %]"
                        [% IF rot_battery == rot %]selected[% END %]>
                    [% rot %]&deg;
                </option>
            [% END %]
        </select>
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_KNOB_POWER_CHARGING" desc="PLUGIN_UNIFIED_HIFI_KNOB_POWER_CHARGING_DESC" %]
        <label style="display: inline-block; width: 120px;">Art mode after:</label>
        <input type="number" name="pref_knob_art_mode_charging" id="pref_knob_art_mode_charging"
               value="[% prefs.knob_art_mode_charging || 60 %]" min="0" max="3600"
               style="width: 60px;" /> sec (0 = disabled)
        <br/><br/>
        <label style="display: inline-block; width: 120px;">Dim after:</label>
        <input type="number" name="pref_knob_dim_charging" id="pref_knob_dim_charging"
               value="[% prefs.knob_dim_charging || 120 %]" min="0" max="3600"
               style="width: 60px;" /> sec (0 = disabled)
        <br/><br/>
        <label style="display: inline-block; width: 120px;">Sleep after:</label>
        <input type="number" name="pref_knob_sleep_charging" id="pref_knob_sleep_charging"
               value="[% prefs.knob_sleep_charging || 0 %]" min="0" max="3600"
               style="width: 60px;" /> sec (0 = disabled)
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_KNOB_POWER_BATTERY" desc="PLUGIN_UNIFIED_HIFI_KNOB_POWER_BATTERY_DESC" %]
        <label style="display: inline-block; width: 120px;">Art mode after:</label>
        <input type="number" name="pref_knob_art_mode_battery" id="pref_knob_art_mode_battery"
               value="[% prefs.knob_art_mode_battery || 30 %]" min="0" max="3600"
               style="width: 60px;" /> sec (0 = disabled)
        <br/><br/>
        <label style="display: inline-block; width: 120px;">Dim after:</label>
        <input type="number" name="pref_knob_dim_battery" id="pref_knob_dim_battery"
               value="[% prefs.knob_dim_battery || 30 %]" min="0" max="3600"
               style="width: 60px;" /> sec (0 = disabled)
        <br/><br/>
        <label style="display: inline-block; width: 120px;">Sleep after:</label>
        <input type="number" name="pref_knob_sleep_battery" id="pref_knob_sleep_battery"
               value="[% prefs.knob_sleep_battery || 60 %]" min="0" max="3600"
               style="width: 60px;" /> sec (0 = disabled)
    [% END %]

[% PROCESS settings/footer.html %]
